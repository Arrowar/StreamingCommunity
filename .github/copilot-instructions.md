# Copilot Instructions

- **Core entrypoints** – The CLI starts in [test_run.py](test_run.py) and [StreamingCommunity/__main__.py](StreamingCommunity/__main__.py) which call [StreamingCommunity/run.py](StreamingCommunity/run.py). The `main()` bootstraps logging, runs config-driven hooks, and dispatches either a site-specific search/download or the global search flow.
- **Site discovery & routing** – [StreamingCommunity/Api/Template/loader.py](StreamingCommunity/Api/Template/loader.py) lazily scans `StreamingCommunity/Api/Service/*/__init__.py`, reading `indice` and `_useFor` to build the selectable site list and rewrites `indice` for ordering. Each site exposes a `search()` function and metadata in its `__init__.py`. Keep that contract intact when adding sites.
- **Search/download lifecycle** – A site `search()` builds results using `MediaManager`/`MediaItem` from [StreamingCommunity/Api/Template/object.py](StreamingCommunity/Api/Template/object.py) and renders tables via [StreamingCommunity/Api/Template/site.py](StreamingCommunity/Api/Template/site.py). Film/series handling typically lives in `film.py`/`series.py` within each site folder and is invoked by the site’s `process_search_result` logic (see [StreamingCommunity/Api/Service/streamingcommunity/__init__.py](StreamingCommunity/Api/Service/streamingcommunity/__init__.py)).
- **Global search** – [StreamingCommunity/global_search.py](StreamingCommunity/global_search.py) aggregates every site’s `search(get_onlyDatabase=True)`, merges results, and allows immediate download of a selected item by reusing the site-specific `search(direct_item=...)` path.
- **Config & domains** – [StreamingCommunity/Util/config_json.py](StreamingCommunity/Util/config_json.py) auto-downloads `config.json`, `login.json`, and `domains.json` if missing, preferring remote domains unless `DEFAULT.fetch_domain_online` is false. Paths are logged at startup; edits must go through `config_manager.config.set_key(...)` + `save_config()` to persist.
- **Hooks** – Pre/post hooks defined under `HOOKS` in `config.json` are executed around `main()` via `_build_command_for_hook` in [StreamingCommunity/run.py](StreamingCommunity/run.py). Supported types: python/bash/sh/cmd/bat/inline; OS filters honored; `continue_on_error` controls fail-fast.
- **Logging** – [StreamingCommunity/Util/logger.py](StreamingCommunity/Util/logger.py) sets levels from `DEFAULT.debug`; debug mode writes a rotating `console.log` while default mode only emits errors to stderr. Avoid adding ad-hoc logging without respecting this configuration.
- **HTTP stack** – Use [StreamingCommunity/Util/http_client.py](StreamingCommunity/Util/http_client.py) helpers (`create_client`, `fetch`, async variants, curl_cffi) to inherit retries, proxy/verify/timeout/User-Agent settings from `REQUESTS` config. Avoid raw `requests/httpx` unless matching this setup.
- **OS & binaries** – [StreamingCommunity/Util/os.py](StreamingCommunity/Util/os.py) sanitizes paths, formats sizes, and probes binaries (ffmpeg, Bento4/mp4decrypt, megatools, Widevine/PlayReady). Import `os_manager`/`os_summary` instead of re-implementing file-system or binary checks.
- **Episode/season utilities** – [StreamingCommunity/Api/Template/episode_manager.py](StreamingCommunity/Api/Template/episode_manager.py) handles season/episode selection, validation, and file name templating (`OUT_FOLDER.map_episode_name`). Reuse these helpers for new site implementations.
- **Configurable CLI flags** – `run.py` maps CLI args (`--specific_list_audio`, `--specific_list_subtitles`, `--force_resolution`, `--not_close`, `--global`, `--auto-first`, `--category`, `--site`) into the config manager before executing. Add new flags by extending `setup_argument_parser()` and `apply_config_updates()` together.
- **Auto-update** – On startup `initialize()` invokes [StreamingCommunity/Upload/update.py](StreamingCommunity/Upload/update.py) to pull the latest domains/changes; failures are non-fatal. The root [update.py](update.py) is a destructive updater with double confirmation—do not call it automatically.
- **GUI (Django)** – The web UI under [GUI/](GUI) wraps the same site logic. Views in [GUI/searchapp/views.py](GUI/searchapp/views.py) call adapters in [GUI/searchapp/api](GUI/searchapp/api) that import the core `search()` functions and pass `direct_item`/`selections` into them. Run with `pip install -r GUI/requirements.txt && python GUI/manage.py migrate && python GUI/manage.py runserver 0.0.0.0:8000`.
- **Docker** – [Makefile](Makefile) provides `make build-container` and `make LOCAL_DIR=/path run-container`, which bind `config.json` and a host download folder; containers expect DNS 1.1.1.1/9.9.9.9 per README guidance.
- **CLI usage examples** – Typical flows: `python test_run.py --site streamingcommunity --search "interstellar" --auto-first`, or `python test_run.py --global -s "cars"`. Install deps with `pip install -r requirements.txt` and consider the DNS requirement noted in [README.md](README.md).
- **Adding a new site** – Create `StreamingCommunity/Api/Service/<sitename>/__init__.py` with metadata (`indice`, `_useFor`, `_region`, `_stream_type`, `_maxResolution`, `_drm`, `_deprecate`) and a `search()` that returns a `MediaManager`; hook it into the GUI by implementing a companion adapter in `GUI/searchapp/api`. Ensure any new files respect the lazy loader’s expectations.
- **Testing/samples** – The [Test/Downloads](Test/Downloads) scripts exercise HLS/DASH/MP4/MEGA downloaders and are the closest to automated checks; no dedicated test runner exists.
- **Safety notes** – The updater and hook system can execute arbitrary commands; be cautious when modifying defaults. `config_manager` will download missing configs/domains from GitHub—mock or pin these files in CI to avoid network reliance.
- **Parallel downloads** – Video and audio streams are downloaded in parallel using `asyncio.gather()` or threading to improve performance. The [StreamingCommunity/Lib/HLS/downloader.py](StreamingCommunity/Lib/HLS/downloader.py) and [StreamingCommunity/Lib/DASH/downloader.py](StreamingCommunity/Lib/DASH/downloader.py) coordinate parallel downloads through the `DownloadManager` class. Each stream uses its own `M3U8_Segments` or `MPD_Segments` instance with sliding window concurrency control to download segments. Progress tracking is available via `get_progress_data()` methods.
- **Segment downloaders** – [StreamingCommunity/Lib/HLS/segments.py](StreamingCommunity/Lib/HLS/segments.py) and [StreamingCommunity/Lib/DASH/segments.py](StreamingCommunity/Lib/DASH/segments.py) implement async segment download with sliding window approach: download N segments in parallel (controlled by `default_video_workers` / `default_audio_workers` config), write them sequentially to maintain order. Each uses `asyncio.Semaphore` for concurrency control and includes retry logic, progress throttling, and stats tracking.

Feel free to suggest tweaks or ask for clarifications if a workflow is still unclear.
